<!DOCTYPE html>
<meta charset="utf-8">
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script>
  MathJax.Hub.Config({
                      tex2jax: {inlineMath: [['$', '$'], ['\\(','\\)']]},
                      TeX: { equationNumbers: {autoNumber: "AMS"} },
                      "HTML-CSS": { showMathMenu: false,
                                    scale: 90 }
                     });
</script>
<link rel="stylesheet" href="http://examples.gurobi.com/base.css">
<style>

.axis path,
.axis line {
    fill: none;
}

.axis text {
    font-family: sans-serif;
    font-size: 11px;
}

</style>
<body>
  <ul id="nav">
    <li class="current"><a href="#intro">Intro</a></li>
    <li><a href="#problem">Problem</a></li>
    <li><a href="#model">Model</a></li>
    <li><a href="#implementation">Implementation</a></li>
    <li><a href="#demo">Live Demo</a></li>
  </ul>
  <div id="example_container">
    <div class="example_section" id="intro">
      <h1>Piecewise Linear Objective</h1>
        <subtitle>with integer programming and Gurobi</subtitle>
    </div>
    Explain use of PWL in Gurobi
    Demonstrate with simple application
    <p> Non-convex optimization </p>

    <div class="example_section" id="problem">
      <h2><a href="#problem" name="problem">Problem Description</a></h2>
      Problem description goes here
      <p> Below is the function
      \[
      \ f(x) = -(x - 2.5)^2 + \sin (kx) + 3
      \]
      and its piecewise linear approximation.</p>
      <p>
      <label for=nData> Number of sample points </label>
      <input type="range" min = 3 max = 30 step = 1 id="nData" value="10" oninput="redraw()" class="slider-width">
      </p>
      <p>
      <label for=k> k </label>
      <input type="range" min = 1 max = 5 step = 0.01 id="k" value="2" oninput="redraw()" class="slider-width">
      </p>

      <div id="piecewisedemo">
      </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
        <script>

        //Width and height
        var width = 700;
        var height = 300;
        var padding = 20;
        var rangeX = 5;
        var data = [];
        var fVals = [];
        var n = 100; // Number of points to draw function
        var nData; // Number of sampled points
        var k;

        var svg = d3.select("#piecewisedemo")
                      .append("svg")
                      .attr("width", width)
                      .attr("height", height);

        // Create scale functions
        var xScale = d3.scale.linear()
                             .domain([0, rangeX])
                             .range([padding, width - padding]);

        var yScale = d3.scale.linear()
                             .domain([-5,5])
                             .range([height - padding, padding]);

        // Create axis functions
        var xAxis = d3.svg.axis()
                          .scale(xScale);

        var yAxis = d3.svg.axis()
                          .scale(yScale)
                          .orient("left");

        // Create line function
        var line = d3.svg.line();

        // G objects for axes
        var xG = svg.append("g")
                    .attr("class", "axis")
                    .attr("stroke", "black")
                    .attr("shape-rendering", "crispEdges")
                    .attr("transform", "translate(0," + height/2 + ")")
                    .call(xAxis);

        var yG = svg.append("g")
                    .attr("class", "axis")
                    .attr("stroke", "black")
                    .attr("shape-rendering", "crispEdges")
                    .attr("transform", "translate(" + padding + ",0)")
                    .call(yAxis);

        // G object for sample points
        var pointsG = svg.append("g");

        // G object for function
        var functionG = svg.append("g");
        var graph = line.interpolate("linear")
                         .x(function(d) { return xScale(d[0]); })
                         .y(function(d) { return yScale(d[1]); });

        redraw();

        function f(x, k) {
          return -(x - 2.5)*(x - 2.5) + Math.sin(k*x) + 3;
        }

        function redraw() {
          console.log('redraw');
          nData = parseInt(document.getElementById("nData").value);
          k = parseFloat(document.getElementById("k").value);
          console.log(nData, k);
          data = [];

          for (var i = 0; i < nData + 1; i++) {
            var x = rangeX*i/nData;
            data.push([x, f(x,k)]);
          }

          fVals = [];

          for (var i = 0; i < n + 1; i++) {
            var x = rangeX*i/n;
            fVals.push([x, f(x,k)]);
          }
          console.log('data', data[5]);
          pointsG.selectAll("circle").remove("circle");
          pointsG.selectAll("path").remove("path");

          pointsG.selectAll("circle")
               .data(data)
               .enter()
               .append("circle")
               .attr("cx", function(d) { return xScale(d[0]); })
               .attr("cy", function(d) { return yScale(d[1]); })
               .attr("r", 4)
               .attr("fill", "gray");

          pointsG.append("path").attr("d", graph(data))
                          .attr("fill", "none")
                          .attr("stroke", "gray");

          functionG.selectAll("path").remove("path");

          functionG.append("path").attr("d", graph(fVals))
                          .attr("fill", "none")
                          .attr("stroke", "blue");
        }

        </script>
    </div>
    <div class="example_section" id="model">
      <h2><a href="#model" name="model">Mathematical Model</a></h2>

      <p>Model description goes here.</p>

    </div>
    <div class="example_section" id="implementation">
      <h2><a href="#implementation" name="implementation">Implementation</a></h2>
      <p>Below is the full implementation of the model (and the associated data) in
        Gurobi's Python interface:
      </p>
      <examplecode>
      Gurobi Code
      </examplecode>
    </div>
    <div class="example_section" id="demo">
      <h2><a href="#demo" name="demo">Live Demo</a></h2>

      <div id="demoarea">
      </div>
      <button class="pure-button" onclick="compute()">Compute</button>
    </div>

    <div style="min-height:100px"></div>

<!--[if gt IE 8]><!--><script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script><!--<![endif]-->
<script src="http://davist11.github.io/jQuery-One-Page-Nav/jquery.nav.js"></script>
<script>
  $(document).ready(function() {
  console.log('calling onePageNav');
  $('#nav').onePageNav();
  });
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script>

//Width and height
var width = 800;
var height = 500;
var colors = d3.scale.category20();

// Initial data
var rate = [20,14,60,23,10];
var profit = [10,11,8,13,11];
var limit = [500,300,420,350,180];
var hours = [40,50,100]; // limithours, maxhours, penalty

var svg = d3.select("#demoarea")
              .append("svg")
              .attr("width", width)
              .attr("height", height);

// G object for background
var backgroundG = svg.append("g");

// G object for solution
var solutionG = svg.append("g");

backgroundG.append("rect")
           .attr("x",0)
           .attr("y",0)
           .attr("width", width)
           .attr("height", height)
           .attr("fill", colors(14));
// optimize(rate, profit, limit, limithours, maxhours, penalty)

function compute() {
  d3.json('/pwlExample.py')
    .header('Content-Type', 'application/json')
    .post(JSON.stringify({'rate': rate, 'profit': profit, 'limit': limit,
                         'hours': hours}), serverResponse);
}

function serverResponse(error, data) {
  console.log('serverResponse');
  console.log('data', data);
  if (!error) {
    if ('solution' in data) {
        // Import solution and put it into correct format
        var sol = data['solution'];
        console.log('solution', sol);
        var solution = sol[0];
        solutionG.selectAll("circle").remove("circle");
        solutionG.selectAll("circle").data(solution).enter()
                  .append("circle").attr("cx", function (d,i) { return (i+1)*width/10; })
                  .attr("cy", height/3)
                  .attr("r", function(d) { return d/20; })
                  .attr("fill", "red");
    }
  }
}

</script>
